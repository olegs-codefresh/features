version: '1.0'

steps:

  build:
    type: build
    image_name: self/testing


  launch:
    type: composition
    title: testing in composition
    composition: ./docker-compose.yaml
    composition_candidates:
    on_success: # Execute only once the step succeeded
      metadata: # Declare the metadata attribute
        set: # Specify the set operation
          - ${{build.imageId}}: # Select any number of target images
            - qa: pending

    on_fail: # Execute only once the step failed
      metadata: # Declare the metadata attribute
        set: # Specify the set operation
          - ${{build.imageId}}: # Select any number of target images
            - exit_code: 1

    on_finish: # Execute in any case
      metadata: # Declare the metadata attribute
        set: # Specify the set operation
          - ${{build.imageId}}: # Select any number of target images
            - is_main:
                evaluate: "'${{CF_BRANCH}}' == 'main'"
